var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i;import{p as o}from"./vendor.6400bf0f.js";var c=[{stage:1,money:300,live:5,enemyAmount:10,enemyPeriod:1200,mapData:{matrix:[[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],start:[0,3],end:[9,10]}},{stage:2,money:100,live:7,enemyAmount:14,enemyPeriod:1200,mapData:{matrix:[[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,0],[0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]],start:[0,9],end:[9,5]}},{stage:3,money:100,live:9,enemyAmount:18,enemyPeriod:1500,mapData:{matrix:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,0,0,0,0,0,0,0,0,1,0,0],[0,0,1,0,1,0,0,0,0,1,1,1,1,1,0,0],[0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0],[0,0,1,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0]],start:[1,0],end:[9,2]}}];class h extends o.exports.Scene{create(){const{width:e,height:t}=this.game.config;this.add.rectangle(e/2,t/2,e,t,4079166),this.add.text(e/2,t/2-100,"塔防遊戲",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"72px"}).setOrigin(.5),this.add.container(e/2,t/2,[this.add.rectangle(0,0,100,50,2105376).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{this.scene.start("stageScene",c[0])})),this.add.text(0,0,"開始").setOrigin(.5)])}}class d{create(e,t,s){this.scene=e,this.statusBar=this._createStatusBar(),this.tanksBar=this._createTanksBar(s),this.placingLayer=this._createPlacingLayer(t)}_createStatusBar(){const e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div");return e.id="status-bar-container",e.style.width="100%",e.style.height="64px",t.id="status-bar",e.appendChild(t),t.appendChild(s),t.appendChild(i),t.appendChild(a),this.scene.add.dom(0,0,e).setOrigin(0),{updateStageText(e){s.innerText=`第 ${e} 關`},updateMoneyText(e){i.innerText=`$: ${e}`},updateLiveText(e){a.innerText=`❤: ${e}`}}}_createTanksBar(e){const t=this._createTankIntro(),s=[],i=[],a=[],n=e.map((e=>this.scene.add.image(0,0,e.imageKey).setInteractive({useHandCursor:!0}).on("pointerover",(()=>{t.updateTankIntroText(e),t.setVisible(!0)})).on("pointerout",(()=>{t.setVisible(!1)})).on("pointermove",(e=>{t.updateTankIntroPosition(e)})).on("pointerup",(()=>{s.forEach((t=>{t(e)}))})).setOrigin(0)));for(let h=0;h<10;h++){const t=40+80*h,s=this.scene.add.container(t,16,[this.scene.add.rectangle(0,0,64,64,4342338).setOrigin(0),...h<e.length?[n[h]]:[]]);a.push(s)}const r=this.scene.add.rectangle(0,0,168,64,14896461).setOrigin(0).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{i.forEach((e=>{e()}))})),o=this.scene.add.container(840,16,[r,this.scene.add.text(84,32,"START",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"30px"}).setOrigin(.5)]),c=this.scene.add.container(0,704,[this.scene.add.rectangle(0,0,1024,96,5921370).setOrigin(0),...a,o]);return{onTankClick(e){s.push(e)},onStartClick(e){i.push(e)},lock(){c.setAlpha(.5),r.disableInteractive(),n.forEach((e=>{e.disableInteractive()}))},unlock(){c.setAlpha(1),r.setInteractive(),n.forEach((e=>{e.setInteractive()}))}}}_createTankIntro(){const e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("div");e.id="tank-intro-container",t.id="tank-intro-bg",e.appendChild(t),s.id="tank-intro-content",t.appendChild(s);const i=this.scene.add.dom(0,0,e).setOrigin(0,1);return i.setVisible(!1),{setVisible(e){i.setVisible(e)},updateTankIntroText(e){s.innerHTML=`${e.name}<br>射擊速度：${e.speed}<br>射程範圍：${e.range}<br>特殊功能：${e.ability}<br>價錢：${e.price}`},updateTankIntroPosition({x:e,y:t}){i.setPosition(e,t)}}}_createPlacingLayer(e){const t=[],s=this.scene.add.container(0,64),i=e.matrix.map(((e,s)=>e.map(((e,i)=>this.scene.add.rectangle(64*i,64*s,64,64).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{t.forEach((e=>{e({rowIndex:s,columnIndex:i})}))})).setOrigin(0).setSize(60).setStrokeStyle(4).setDisplayOrigin(-2,-2)))));s.add(i.flat()),s.setVisible(!1);const a=this._createPreviewTank();return{setVisible(e){s.setVisible(e),a.setVisible(e)},updatePreviewTank:a.updatePreviewTank,updatePlacingGridMap(e){i.forEach(((t,s)=>{t.forEach(((t,i)=>{const a=e[s][i]?3135122:16723513;t.setStrokeStyle(4,a)}))}))},onPlacingGridClick(e){t.push(e)}}}_createPreviewTank(){const e=this.scene.add.container(0,0),t=this.scene.add.ellipse(0,0,0,0,15568017,.3),s=this.scene.add.image(0,0);return e.add([t,s]),e.setVisible(!1),this.scene.input.on("pointermove",(({x:t,y:s})=>{e.setPosition(t,s)})),{setVisible(t){e.setVisible(t)},updatePreviewTank(e){s.setTexture(e.imageKey),t.setSize(64*e.range*2,64*e.range*2).setOrigin(.5)}}}lock(){this.tanksBar.lock()}unlock(){this.tanksBar.unlock()}}class l extends o.exports.GameObjects.Sprite{constructor(e,t,s,i){super(e.scene,64*s+32,64*t+32,i.imageKey),this.setOrigin(.5),this.map=e,this.scene=e.scene,this.tankData=i,this.lastAttackTime=-1,this.rangeDistance=64*i.range,this.lockedOnEnemy=void 0}update(e){if(void 0===this.lockedOnEnemy)return;const t=o.exports.Math.Angle.Between(this.x,this.y,this.lockedOnEnemy.x,this.lockedOnEnemy.y);this.setRotation(t+1*o.exports.Math.PI2/4),e-this.lastAttackTime>1e3/this.tankData.speed&&(this.attack(this.lockedOnEnemy),this.lastAttackTime=e)}lockOnEnemy(e){this.lockedOnEnemy=e.getChildren().find((e=>{if(!e.active)return!1;return o.exports.Math.Distance.Between(this.x,this.y,e.x,e.y)<=this.rangeDistance+64*e.enemyData.size}))}attack(e){console.log(this.tankData.name,"attack"),this.map.addBullet(this,e)}}class p extends o.exports.GameObjects.Ellipse{constructor(e,t,s,i,a){super(e.scene,64*s+32,64*t+32,64*i.size*2,64*i.size*2,i.color),this.scene=e.scene,this.enemyData=i,this._live=i.live,this.path=a,this.setOrigin(.5),this.follower={t:0,vec:new o.exports.Math.Vector2},this.startOnPath()}get live(){return this._live}set live(e){this.active&&(this._live=e,e<=0&&(this.setActive(!1),this.setVisible(!1),this.scene.money+=this.enemyData.money,console.log("enemy die")))}startOnPath(){this.follower.t=0,this.path.getPoint(this.follower.t,this.follower.vec),this.setPosition(this.follower.vec.x,this.follower.vec.y)}update(e,t){this.active&&(t/=1e3,this.follower.t+=t*this.enemyData.speed/(this.path.getLength()/64),this.path.getPoint(this.follower.t,this.follower.vec),this.setPosition(this.follower.vec.x,this.follower.vec.y),this.follower.t>=1&&(this.setActive(!1),this.setVisible(!1),this.scene.live-=1))}}class m extends o.exports.GameObjects.Ellipse{constructor(e,t,s){super(e.scene,t.x,t.y,7,7,0),this.scene=e.scene,this.map=e,this.tank=t,this.enemy=s}update(e,t){if(!this.active)return;t/=1e3;const s=new o.exports.Math.Vector2(this.enemy.x-this.x,this.enemy.y-this.y).normalize(),i=this.x+1.7*t*64*s.x,a=this.y+1.7*t*64*s.y;this.setPosition(i,a);o.exports.Math.Distance.Between(this.x,this.y,this.enemy.x,this.enemy.y)<=3.5+64*this.enemy.enemyData.size&&(this.setActive(!1),this.setVisible(!1),this.enemy.live-=1)}}function g(e){return new Promise((t=>{setTimeout(t,e)}))}class u{create(e,t){this.scene=e,this.placingMatrix=t.matrix.map(((e,t)=>e.map(((e,t)=>0===e)))),this.tanks=this.scene.add.group(),this.enemies=this.scene.add.group(),this.bullets=this.scene.add.group(),this.mainContainer=this.scene.add.container(0,64),this._createBackground(t),this.path=this._createPath(t)}update(e,t){this.enemies.children.iterate((s=>{s.update(e,t)})),this.tanks.children.iterate((t=>{t.lockOnEnemy(this.enemies),t.update(e)})),this.bullets.children.iterate((s=>{s.update(e,t)}));this.enemies.getChildren().some((e=>e.active))||this.enemies.getLength()!==this.scene.stageData.enemyAmount||(this.scene.status="gameWinner")}_createBackground(e){const t=this.scene.add.container(0,0),s=e.matrix.map(((e,t)=>e.map(((e,s)=>{const i={0:10013806,1:15913593};return this.scene.add.rectangle(64*s,64*t,64,64,i[e]).setOrigin(0)}))));t.add([...s.flat(),this.scene.add.container(64*e.start[1],64*e.start[0],[this.scene.add.rectangle(0,0,64,64,15124339).setOrigin(0),this.scene.add.text(32,32,"START",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"15px",color:"#6e5e31"}).setOrigin(.5)]),this.scene.add.container(64*e.end[1],64*e.end[0],[this.scene.add.rectangle(0,0,64,64,15124339).setOrigin(0),this.scene.add.text(32,32,"END",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"15px",color:"#6e5e31"}).setOrigin(.5)])]),this.mainContainer.add(t)}_findPath({matrix:e,start:t}){const s=e.flatMap(((e,t)=>e.map(((e,s)=>[e,t,s])))).filter((e=>1===e[0])).map((e=>{const[,...t]=e;return t})),i=[];for(;s.length>0;){if(0===i.length){const e=s.findIndex((e=>t[0]===e[0]&&t[1]===e[1]));i.push(...s.splice(e,1))}const e=i.slice(-1)[0],a=[s.findIndex((t=>e[0]+1===t[0]&&e[1]===t[1])),s.findIndex((t=>e[0]-1===t[0]&&e[1]===t[1])),s.findIndex((t=>e[0]===t[0]&&e[1]-1===t[1])),s.findIndex((t=>e[0]===t[0]&&e[1]+1===t[1]))].find((e=>-1!==e));i.push(...s.splice(a,1))}return i}_createPath(e){const t=this._findPath(e),s=this.scene.add.graphics(),i=this.scene.add.path(0,0);return t.map((([e,t])=>[64*t,64*e])).forEach((([e,t],s)=>{const a=e+32,n=t+32;0!==s?i.lineTo(a,n):i.moveTo(a,n)})),s.lineStyle(3,16777215,0),i.draw(s),this.mainContainer.add(s),i}addTank(e,t,s){const i=new l(this,t,s,e);this.mainContainer.add(i),this.tanks.add(i),this.placingMatrix[t][s]=!1}canPlaceAt(e,t){return this.placingMatrix[e][t]}addEnemy(e,t,s){const i=new p(this,t,s,e,this.path);this.mainContainer.add(i),this.enemies.add(i)}async addEnemies(e,t,s,i,a){this.addEnemy(e,t,s);for(let n=1;n<i;n++)await g(a),this.addEnemy(e,t,s)}addBullet(e,t){const s=new m(this,e,t);this.mainContainer.add(s),this.bullets.add(s)}}var y=[{name:"黃金一級獵犬砲台",image:"/final/assets/tank_1.ca2959c3.png",imageKey:"tank-brown",range:1.5,speed:1,ability:"無",price:50},{name:"金剛二級鸚鵡砲台",image:"/final/assets/tank_2.181a4c2d.png",imageKey:"tank-red",range:2,speed:1.5,ability:"無",price:100},{name:"殺人鯨三級砲台",image:"/final/assets/tank_3.af59195d.png",imageKey:"tank-blue",range:2.5,speed:2,ability:"無",price:150}],v=[{live:3,speed:.5,color:9393302,size:.15,money:25},{live:5,speed:.7,color:3108034,size:.2,money:30},{live:8,speed:.8,color:10228756,size:.25,money:35}];class f extends o.exports.Scene{preload(){y.forEach((e=>{this.load.image(e.imageKey,e.image)})),this.load.audio("bgm",["/final/assets/BgmUI_Title.e26905fb.mp3"])}create(e){this.sound.add("bgm",{loop:!0}).play(),this._status="placing",this._stage=1,this._money=1,this._live=1,this._previewTankData=null,this.stageData=e,this.stageMap=new u,this.ui=new d,this.stageMap.create(this,e.mapData),this.ui.create(this,e.mapData,y),this.stage=e.stage,this.money=e.money,this.live=e.live;this.ui.tanksBar.onTankClick((e=>{if(this.previewTankData===e)return this.ui.placingLayer.setVisible(!1),void(this.previewTankData=null);this.money<e.price||(this.previewTankData=e,this.ui.placingLayer.updatePlacingGridMap(this.stageMap.placingMatrix),this.ui.placingLayer.setVisible(!0))}));this.ui.placingLayer.onPlacingGridClick((({rowIndex:e,columnIndex:t})=>{this.stageMap.canPlaceAt(e,t)&&(this.money-=this.previewTankData.price,this.stageMap.addTank(this.previewTankData,e,t),this.ui.placingLayer.setVisible(!1),this.previewTankData=null)}));this.ui.tanksBar.onStartClick((()=>{this.status="battling"}))}update(e,t){this.stageMap.update(e,t)}get status(){return this._status}set status(e){if(this._status=e,"placing"===e)this.ui.unlock();else if("battling"===e)this.stageMap.addEnemies(v[this.stage-1],this.stageData.mapData.start[0],this.stageData.mapData.start[1],this.stageData.enemyAmount,this.stageData.enemyPeriod),this.ui.lock();else if("gameLoser"===e)this.scene.start("loseScene"),console.log("you are loser");else if("gameWinner"===e)if(c.length===this.stage)this.scene.start("winScene");else{const e=c[this.stage];this.scene.start("stageScene",(o=((e,t)=>{for(var s in t||(t={}))a.call(t,s)&&r(e,s,t[s]);if(i)for(var s of i(t))n.call(t,s)&&r(e,s,t[s]);return e})({},e),h={money:e.money+this.money},t(o,s(h))))}var o,h}get stage(){return this._stage}set stage(e){this._stage=e,this.ui.statusBar.updateStageText(this._stage)}get money(){return this._money}set money(e){this._money=e,this.ui.statusBar.updateMoneyText(this._money)}get live(){return this._live}set live(e){this.live<=0||(this._live=e,this.ui.statusBar.updateLiveText(this._live),e<=0&&(this.status="gameLoser"))}get previewTankData(){return this._previewTankData}set previewTankData(e){this._previewTankData=e,null!==e&&this.ui.placingLayer.updatePreviewTank(this._previewTankData)}}class x extends o.exports.Scene{create(){const{width:e,height:t}=this.game.config;this.add.rectangle(e/2,t/2,e,t,4079166),this.add.text(e/2,t/2-100,"你輸了！ : (",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"72px"}).setOrigin(.5),this.add.container(e/2,t/2,[this.add.rectangle(0,0,100,50,2105376).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{this.scene.start("welcomeScene")})),this.add.text(0,0,"回到主畫面").setOrigin(.5)])}}class k extends o.exports.Scene{create(){const{width:e,height:t}=this.game.config;this.add.rectangle(e/2,t/2,e,t,4079166),this.add.text(e/2,t/2-100,"你贏了！你好棒 : )",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"72px"}).setOrigin(.5),this.add.container(e/2,t/2,[this.add.rectangle(0,0,100,50,2105376).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{this.scene.start("welcomeScene")})),this.add.text(0,0,"回到主畫面").setOrigin(.5)])}}!function(){const e={parent:"game",dom:{createContainer:!0},type:o.exports.AUTO,width:1024,height:800,physics:{default:"arcade",arcade:{debug:!1}}},t=new o.exports.Game(e);t.scene.add("welcomeScene",new h),t.scene.add("stageScene",new f),t.scene.add("loseScene",new x),t.scene.add("winScene",new k),t.scene.start("welcomeScene")}();
