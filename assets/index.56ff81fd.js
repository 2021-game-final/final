import{p as e}from"./vendor.6400bf0f.js";var t=[{stage:1,money:300,live:5,enemyAmount:10,enemyPeriod:1200,mapData:{matrix:[[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]],start:[0,3],end:[9,10]}},{stage:2,money:100,live:7,enemyAmount:14,enemyPeriod:1200,mapData:{matrix:[[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,0],[0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]],start:[0,9],end:[9,5]}},{stage:3,money:100,live:9,enemyAmount:18,enemyPeriod:1500,mapData:{matrix:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,0,0,0,0,0,0,0,0,1,0,0],[0,0,1,0,1,0,0,0,0,1,1,1,1,1,0,0],[0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0],[0,0,1,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0]],start:[1,0],end:[9,2]}}];class i extends e.exports.Scene{create(){const{width:e,height:i}=this.game.config;this.add.rectangle(e/2,i/2,e,i,4079166),this.add.text(e/2,i/2-100,"塔防遊戲",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"72px"}).setOrigin(.5),this.add.container(e/2,i/2,[this.add.rectangle(0,0,100,50,2105376).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{this.scene.start("stageScene",t[0])})),this.add.text(0,0,"開始").setOrigin(.5)])}}class a{create(e,t,i){this.scene=e,this.statusBar=this._createStatusBar(),this.tanksBar=this._createTanksBar(i),this.placingLayer=this._createPlacingLayer(t)}_createStatusBar(){const e=document.createElement("div"),t=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),s=document.createElement("div");return e.id="status-bar-container",e.style.width="100%",e.style.height="64px",t.id="status-bar",e.appendChild(t),t.appendChild(i),t.appendChild(a),t.appendChild(s),this.scene.add.dom(0,0,e).setOrigin(0),{updateStageText(e){i.innerText=`第 ${e} 關`},updateMoneyText(e){a.innerText=`$: ${e}`},updateLiveText(e){s.innerText=`❤: ${e}`}}}_createTanksBar(e){const t=this._createTankIntro(),i=[],a=[],s=[],n=e.map((e=>this.scene.add.image(0,0,e.imageKey).setInteractive({useHandCursor:!0}).on("pointerover",(()=>{t.updateTankIntroText(e),t.setVisible(!0)})).on("pointerout",(()=>{t.setVisible(!1)})).on("pointermove",(e=>{t.updateTankIntroPosition(e)})).on("pointerup",(()=>{i.forEach((t=>{t(e)}))})).setOrigin(0)));for(let h=0;h<10;h++){const t=40+80*h,i=this.scene.add.container(t,16,[this.scene.add.rectangle(0,0,64,64,4342338).setOrigin(0),...h<e.length?[n[h]]:[]]);s.push(i)}const r=this.scene.add.rectangle(0,0,168,64,14896461).setOrigin(0).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{a.forEach((e=>{e()}))})),o=this.scene.add.container(840,16,[r,this.scene.add.text(84,32,"START",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"30px"}).setOrigin(.5)]),c=this.scene.add.container(0,704,[this.scene.add.rectangle(0,0,1024,96,5921370).setOrigin(0),...s,o]);return{onTankClick(e){i.push(e)},onStartClick(e){a.push(e)},lock(){c.setAlpha(.5),r.disableInteractive(),n.forEach((e=>{e.disableInteractive()}))},unlock(){c.setAlpha(1),r.setInteractive(),n.forEach((e=>{e.setInteractive()}))}}}_createTankIntro(){const e=document.createElement("div"),t=document.createElement("div"),i=document.createElement("div");e.id="tank-intro-container",t.id="tank-intro-bg",e.appendChild(t),i.id="tank-intro-content",t.appendChild(i);const a=this.scene.add.dom(0,0,e).setOrigin(0,1);return a.setVisible(!1),{setVisible(e){a.setVisible(e)},updateTankIntroText(e){i.innerHTML=`${e.name}<br>射擊速度：${e.speed}<br>射程範圍：${e.range}<br>特殊功能：${e.ability}<br>價錢：${e.price}`},updateTankIntroPosition({x:e,y:t}){a.setPosition(e,t)}}}_createPlacingLayer(e){const t=[],i=this.scene.add.container(0,64),a=e.matrix.map(((e,i)=>e.map(((e,a)=>this.scene.add.rectangle(64*a,64*i,64,64).setInteractive({useHandCursor:!0}).on("pointerup",(()=>{t.forEach((e=>{e({rowIndex:i,columnIndex:a})}))})).setOrigin(0).setSize(60).setStrokeStyle(4).setDisplayOrigin(-2,-2)))));i.add(a.flat()),i.setVisible(!1);const s=this._createPreviewTank();return{setVisible(e){i.setVisible(e),s.setVisible(e)},updatePreviewTank:s.updatePreviewTank,updatePlacingGridMap(e){a.forEach(((t,i)=>{t.forEach(((t,a)=>{const s=e[i][a]?3135122:16723513;t.setStrokeStyle(4,s)}))}))},onPlacingGridClick(e){t.push(e)}}}_createPreviewTank(){const e=this.scene.add.container(0,0),t=this.scene.add.ellipse(0,0,0,0,15568017,.3),i=this.scene.add.image(0,0);return e.add([t,i]),e.setVisible(!1),this.scene.input.on("pointermove",(({x:t,y:i})=>{e.setPosition(t,i)})),{setVisible(t){e.setVisible(t)},updatePreviewTank(e){i.setTexture(e.imageKey),t.setSize(64*e.range*2,64*e.range*2).setOrigin(.5)}}}lock(){this.tanksBar.lock()}unlock(){this.tanksBar.unlock()}}class s extends e.exports.GameObjects.Sprite{constructor(e,t,i,a){super(e.scene,64*i+32,64*t+32,a.imageKey),this.setOrigin(.5),this.map=e,this.scene=e.scene,this.data=a,this.lastAttackTime=-1,this.rangeDistance=64*a.range,this.lockedOnEnemy=void 0}update(t){if(void 0===this.lockedOnEnemy)return;const i=e.exports.Math.Angle.Between(this.x,this.y,this.lockedOnEnemy.x,this.lockedOnEnemy.y);this.setRotation(i+1*e.exports.Math.PI2/4),t-this.lastAttackTime>1e3/this.data.speed&&(this.attack(this.lockedOnEnemy),this.lastAttackTime=t)}lockOnEnemy(t){this.lockedOnEnemy=t.getChildren().find((t=>{const i=e.exports.Math.Distance.Between(this.x,this.y,t.x,t.y);return this.rangeDistance+64*t.enemyData.size>=i}))}attack(e){console.log(this.data.name,"attack"),this.map.addBullet(this,e)}}class n extends e.exports.GameObjects.Ellipse{constructor(t,i,a,s,n){super(t.scene,64*a+32,64*i+32,64*s.size*2,64*s.size*2,s.color),this.scene=t.scene,this.enemyData=s,this.path=n,this.setOrigin(.5),this.follower={t:0,vec:new e.exports.Math.Vector2},this.startOnPath()}startOnPath(){this.follower.t=0,this.path.getPoint(this.follower.t,this.follower.vec),this.setPosition(this.follower.vec.x,this.follower.vec.y)}update(e,t){t/=1e3,this.follower.t+=t*this.enemyData.speed/(this.path.getLength()/64),this.path.getPoint(this.follower.t,this.follower.vec),this.setPosition(this.follower.vec.x,this.follower.vec.y),this.follower.t>=1&&this.setActive(!1)}}class r extends e.exports.GameObjects.Ellipse{constructor(e,t,i){super(e.scene,t.x,t.y,7,7,0),this.scene=e.scene,this.tank=t,this.enemy=i}update(t,i){i/=1e3;const a=new e.exports.Math.Vector2(this.enemy.x-this.x,this.enemy.y-this.y).normalize(),s=this.x+1.7*i*64*a.x,n=this.y+1.7*i*64*a.y;this.setPosition(s,n)}}function o(e){return new Promise((t=>{setTimeout(t,e)}))}class c{create(e,t){this.scene=e,this.placingMatrix=t.matrix.map(((e,t)=>e.map(((e,t)=>0===e)))),this.tanks=this.scene.add.group(),this.enemies=this.scene.add.group(),this.bullets=this.scene.add.group(),this.mainContainer=this.scene.add.container(0,64),this._createBackground(t),this.path=this._createPath(t)}update(e,t){this.enemies.children.iterate((i=>{i.update(e,t)})),this.tanks.children.iterate((t=>{t.lockOnEnemy(this.enemies),t.update(e)})),this.bullets.children.iterate((i=>{i.update(e,t)}))}_createBackground(e){const t=this.scene.add.container(0,0),i=e.matrix.map(((e,t)=>e.map(((e,i)=>{const a={0:10013806,1:15913593};return this.scene.add.rectangle(64*i,64*t,64,64,a[e]).setOrigin(0)}))));t.add([...i.flat(),this.scene.add.container(64*e.start[1],64*e.start[0],[this.scene.add.rectangle(0,0,64,64,15124339).setOrigin(0),this.scene.add.text(32,32,"START",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"15px",color:"#6e5e31"}).setOrigin(.5)]),this.scene.add.container(64*e.end[1],64*e.end[0],[this.scene.add.rectangle(0,0,64,64,15124339).setOrigin(0),this.scene.add.text(32,32,"END",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:"15px",color:"#6e5e31"}).setOrigin(.5)])]),this.mainContainer.add(t)}_findPath({matrix:e,start:t}){const i=e.flatMap(((e,t)=>e.map(((e,i)=>[e,t,i])))).filter((e=>1===e[0])).map((e=>{const[,...t]=e;return t})),a=[];for(;i.length>0;){if(0===a.length){const e=i.findIndex((e=>t[0]===e[0]&&t[1]===e[1]));a.push(...i.splice(e,1))}const e=a.slice(-1)[0],s=[i.findIndex((t=>e[0]+1===t[0]&&e[1]===t[1])),i.findIndex((t=>e[0]-1===t[0]&&e[1]===t[1])),i.findIndex((t=>e[0]===t[0]&&e[1]-1===t[1])),i.findIndex((t=>e[0]===t[0]&&e[1]+1===t[1]))].find((e=>-1!==e));a.push(...i.splice(s,1))}return a}_createPath(e){const t=this._findPath(e),i=this.scene.add.graphics(),a=this.scene.add.path(0,0);return t.map((([e,t])=>[64*t,64*e])).forEach((([e,t],i)=>{const s=e+32,n=t+32;0!==i?a.lineTo(s,n):a.moveTo(s,n)})),i.lineStyle(3,16777215,0),a.draw(i),this.mainContainer.add(i),a}addTank(e,t,i){const a=new s(this,t,i,e);this.mainContainer.add(a),this.tanks.add(a),this.placingMatrix[t][i]=!1}canPlaceAt(e,t){return this.placingMatrix[e][t]}addEnemy(e,t,i){const a=new n(this,t,i,e,this.path);this.mainContainer.add(a),this.enemies.add(a)}async addEnemies(e,t,i,a,s){this.addEnemy(e,t,i);for(let n=1;n<a;n++)await o(s),this.addEnemy(e,t,i)}addBullet(e,t){const i=new r(this,e,t);this.mainContainer.add(i),this.bullets.add(i)}}var h=[{name:"黃金一級獵犬砲台",image:"/final/assets/tank_1.ca2959c3.png",imageKey:"tank-brown",range:1.5,speed:1,ability:"無",price:50},{name:"金剛二級鸚鵡砲台",image:"/final/assets/tank_2.181a4c2d.png",imageKey:"tank-red",range:2,speed:1.5,ability:"無",price:100},{name:"殺人鯨三級砲台",image:"/final/assets/tank_3.af59195d.png",imageKey:"tank-blue",range:2.5,speed:2,ability:"無",price:150}],d=[{live:2,speed:.5,color:9393302,size:.15,money:25},{live:3,speed:.7,color:3108034,size:.2,money:30},{live:5,speed:.8,color:10228756,size:.25,money:35}];class l extends e.exports.Scene{preload(){h.forEach((e=>{this.load.image(e.imageKey,e.image)}))}create(e){this._status="placing",this._stage=0,this._money=0,this._live=0,this._previewTankData=null,this.stageData=e,this.stageMap=new c,this.ui=new a,this.stageMap.create(this,e.mapData),this.ui.create(this,e.mapData,h),this.stage=e.stage,this.money=e.money,this.live=e.live;this.ui.tanksBar.onTankClick((e=>{if(this.previewTankData===e)return this.ui.placingLayer.setVisible(!1),void(this.previewTankData=null);this.money<e.price||(this.previewTankData=e,this.ui.placingLayer.updatePlacingGridMap(this.stageMap.placingMatrix),this.ui.placingLayer.setVisible(!0))}));this.ui.placingLayer.onPlacingGridClick((({rowIndex:e,columnIndex:t})=>{this.stageMap.canPlaceAt(e,t)&&(this.money-=this.previewTankData.price,this.stageMap.addTank(this.previewTankData,e,t),this.ui.placingLayer.setVisible(!1),this.previewTankData=null)}));this.ui.tanksBar.onStartClick((()=>{this.status="battling"}))}update(e,t){this.stageMap.update(e,t)}get status(){return this._status}set status(e){this._status=e,"placing"===e?this.ui.unlock():"battling"===e&&(this.stageMap.addEnemies(d[this.stage-1],this.stageData.mapData.start[0],this.stageData.mapData.start[1],this.stageData.enemyAmount,this.stageData.enemyPeriod),this.ui.lock())}get stage(){return this._stage}set stage(e){this._stage=e,this.ui.statusBar.updateStageText(this._stage)}get money(){return this._money}set money(e){this._money=e,this.ui.statusBar.updateMoneyText(this._money)}get live(){return this._live}set live(e){this._live=e,this.ui.statusBar.updateLiveText(this._live)}get previewTankData(){return this._previewTankData}set previewTankData(e){this._previewTankData=e,null!==e&&this.ui.placingLayer.updatePreviewTank(this._previewTankData)}}!function(){const t={parent:"game",dom:{createContainer:!0},type:e.exports.AUTO,width:1024,height:800,physics:{default:"arcade",arcade:{debug:!1}}},a=new e.exports.Game(t);a.scene.add("welcomeScene",new i),a.scene.add("stageScene",new l),a.scene.start("welcomeScene")}();
